<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .timetable-grid {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 400px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéì Automated Timetable Scheduling System</h1>

        <div class="card">
            <h2>System Status</h2>
            <div id="status" class="status info">Checking server connection...</div>
            <div class="stats" id="stats"></div>
        </div>

        <div class="card">
            <h2>Quick Actions</h2>
            <div class="button-group">
                <button onclick="generateTimetable()" class="success">üöÄ Generate Timetable</button>
                <button onclick="viewTimetable()">üìÖ View Timetable</button>
                <button onclick="detectConflicts()" class="success">üîç Detect Conflicts</button>
                <button onclick="viewConflicts()">‚ö†Ô∏è View Conflicts</button>
                <button onclick="resolveConflicts()"
                    style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">‚ú® Resolve Conflicts</button>
                <button onclick="viewData('faculty')">üë®‚Äçüè´ View Faculties</button>
                <button onclick="viewData('course')">üìö View Courses</button>
                <button onclick="viewData('room')">üè´ View Rooms</button>
                <button onclick="viewData('section')">üë• View Sections</button>
                <button onclick="viewData('timeslot')">‚è∞ View Timeslots</button>
                <button onclick="showReschedulingUI()"
                    style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);">üîÑ Dynamic
                    Rescheduling</button>
                <button onclick="clearTimetable()" class="secondary">üóëÔ∏è Clear Timetable</button>

                <div id="versionControl"
                    style="display:none; margin-left: auto; align-items: center; background: #f8f9fa; padding: 5px 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <label style="margin-right: 10px; font-weight: 600; color: #667eea;">Select Plan:</label>
                    <select id="versionSelect" onchange="onVersionChange(this.value)"
                        style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; outline: none; margin-right: 10px;">
                    </select>
                    <button onclick="downloadCSV()" title="Download as CSV"
                        style="padding: 5px 12px; font-size: 14px; background: #28a745; margin: 0;">üíæ CSV</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Results</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:5000');
                const data = await response.json();
                showStatus('Server is running! ‚úÖ', 'success');
                await loadStats();
            } catch (error) {
                showStatus('Server is not running. Please start the backend server. ‚ùå', 'error');
            }
        }

        async function loadStats() {
            try {
                const [faculties, courses, rooms, sections, timeslots, timetable] = await Promise.all([
                    fetch(`${API_URL}/faculty`).then(r => r.json()),
                    fetch(`${API_URL}/course`).then(r => r.json()),
                    fetch(`${API_URL}/room`).then(r => r.json()),
                    fetch(`${API_URL}/section`).then(r => r.json()),
                    fetch(`${API_URL}/timeslot`).then(r => r.json()),
                    fetch(`${API_URL}/timetable`).then(r => r.json())
                ]);

                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <h3>${faculties.count || 0}</h3>
                        <p>Faculties</p>
                    </div>
                    <div class="stat-card">
                        <h3>${courses.count || 0}</h3>
                        <p>Courses</p>
                    </div>
                    <div class="stat-card">
                        <h3>${rooms.count || 0}</h3>
                        <p>Rooms</p>
                    </div>
                    <div class="stat-card">
                        <h3>${sections.count || 0}</h3>
                        <p>Sections</p>
                    </div>
                    <div class="stat-card">
                        <h3>${timeslots.count || 0}</h3>
                        <p>Timeslots</p>
                    </div>
                    <div class="stat-card">
                        <h3>${timetable.count || 0}</h3>
                        <p>Scheduled Classes</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function generateTimetable() {
            showStatus('Generating timetable... ‚è≥', 'info');
            document.getElementById('results').innerHTML = '<div class="loading">Generating timetable...</div>';

            try {
                const response = await fetch(`${API_URL}/timetable/generate`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    showStatus(`Timetable generated successfully! ${data.entries} classes scheduled. ‚úÖ`, 'success');
                    displayJSON(data);
                    await loadStats();
                    if (data.rankings) {
                        updateVersionDropdown(data.rankings);
                        // Automatically view the best one
                        if (data.rankings.length > 0) viewTimetable(data.rankings[0].id);
                    }
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                    displayJSON(data);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = `<pre>${error.message}</pre>`;
            }
        }

        async function viewTimetable(proposalId = null) {
            currentView = 'timetable'; // Set active view state

            // Use selected ID if not provided
            if (!proposalId) {
                const select = document.getElementById('versionSelect');
                if (select && select.value) proposalId = select.value;
            }

            // If still no ID (e.g. no generated data), warn user
            if (!proposalId) {
                // Try to fetch versions to populate dropdown if empty
                await loadVersions();
                const select = document.getElementById('versionSelect');
                if (select && select.value) proposalId = select.value;

                if (!proposalId) {
                    showStatus('No generated timetables found. Please generate one first.', 'info');
                    return;
                }
            }

            // Sync dropdown if called programmatically
            const select = document.getElementById('versionSelect');
            if (select && select.value !== proposalId) {
                select.value = proposalId;
            }

            showStatus('Loading timetable... ‚è≥', 'info');
            document.getElementById('results').innerHTML = '<div class="loading">Loading timetable...</div>';

            try {
                let url = `${API_URL}/timetable`;
                if (proposalId) url += `?proposalId=${proposalId}`;

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.data && data.data.length > 0) {
                    showStatus(`Loaded ${data.count} timetable entries (Plan ID: ${proposalId}). ‚úÖ`, 'success');
                    displayTimetableTable(data.data);
                } else {
                    showStatus('No timetable entries found for this plan.', 'info');
                    document.getElementById('results').innerHTML = '<p>No entries found.</p>';
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = `<pre>${error.message}</pre>`;
            }
        }

        async function viewData(type) {
            currentView = 'data'; // Disable dropdown automations
            showStatus(`Loading ${type} data... ‚è≥`, 'info');
            document.getElementById('results').innerHTML = '<div class="loading">Loading data...</div>';

            try {
                const response = await fetch(`${API_URL}/${type}`);
                const data = await response.json();

                if (response.ok) {
                    showStatus(`Loaded ${data.count} ${type} records. ‚úÖ`, 'success');
                    displayJSON(data);
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                    displayJSON(data);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = `<pre>${error.message}</pre>`;
            }
        }

        async function clearTimetable() {
            if (!confirm('Are you sure you want to clear all timetable entries?')) {
                return;
            }

            showStatus('Clearing timetable... ‚è≥', 'info');

            try {
                const response = await fetch(`${API_URL}/timetable`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (response.ok) {
                    showStatus('Timetable cleared successfully! ‚úÖ', 'success');
                    document.getElementById('results').innerHTML = '';
                    await loadStats();
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function displayJSON(data) {
            document.getElementById('results').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        function displayTimetableTable(entries) {
            let html = '<div class="timetable-grid"><table>';
            html += '<thead><tr><th>Section</th><th>Course</th><th>Faculty</th><th>Room</th><th>Day</th><th>Slot</th></tr></thead>';
            html += '<tbody>';

            entries.forEach(entry => {
                html += `<tr>
                    <td>${entry.sectionId?.name || 'N/A'}</td>
                    <td>${entry.courseId?.name || 'N/A'} (${entry.courseId?.courseType || 'N/A'})</td>
                    <td>${entry.facultyId?.name || 'N/A'}</td>
                    <td>${entry.roomId?.name || ('Room ' + entry.roomId?._id?.toString().slice(-4))} (${entry.roomId?.roomType || 'N/A'})</td>
                    <td>${entry.timeslotId?.day || 'N/A'}</td>
                    <td>Slot ${entry.timeslotId?.slot || 'N/A'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            document.getElementById('results').innerHTML = html;
        }



        function displayConflictsTable(conflicts) {
            let html = '<div class="timetable-grid"><table>';
            html += '<thead><tr><th>Type</th><th>Reason</th><th>Entity ID</th><th>Timeslot ID</th></tr></thead>';
            html += '<tbody>';

            conflicts.forEach(conflict => {
                const typeColors = {
                    'faculty': '#ff6b6b',
                    'room': '#ffa500',
                    'section': '#ff1493'
                };
                const color = typeColors[conflict.type] || '#667eea';

                html += `<tr style="background-color: ${color}15;">
                    <td><span style="background: ${color}; color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600;">${conflict.type.toUpperCase()}</span></td>
                    <td style="font-weight: 500;">${conflict.reason}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">${conflict.entityId?.toString().slice(-8) || 'N/A'}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">${conflict.timeslotId?.day || 'N/A'} - Slot ${conflict.timeslotId?.slot || 'N/A'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            document.getElementById('results').innerHTML = html;
        }

        // Check server status on load
        checkServerStatus();
        loadVersions(); // Check if there are existing versions on load

        async function loadVersions() {
            try {
                const response = await fetch(`${API_URL}/timetable/versions`);
                if (response.ok) {
                    const data = await response.json();
                    updateVersionDropdown(data.data);
                }
            } catch (e) { console.error(e); }
        }

        function updateVersionDropdown(versions) {
            const select = document.getElementById('versionSelect');
            const container = document.getElementById('versionControl');

            if (!versions || versions.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            const currentVal = select.value;
            select.innerHTML = versions.map(v =>
                `<option value="${v.id}">Rank ${v.rank} (Score: ${Math.round(v.score)})</option>`
            ).join('');

            // Restore selection or default to first
            if (currentVal && versions.some(v => v.id == currentVal)) {
                select.value = currentVal;
            } else if (versions.length > 0) {
                select.value = versions[0].id;
            }
        }

        let currentView = 'home';

        async function onVersionChange(id) {
            if (currentView === 'timetable') {
                await viewTimetable(id);
            } else if (currentView === 'conflicts') {
                await detectConflicts(id); // Dynamically re-detect for the new ID
            }
        }

        // ... update detectConflicts ...
        async function detectConflicts(proposalId = null) {
            currentView = 'conflicts';
            // Use selected ID if not provided
            if (!proposalId) {
                const select = document.getElementById('versionSelect');
                if (select && select.value) proposalId = select.value;
            }

            // If still no ID, try to default or warn
            if (!proposalId) {
                // If we have no ID, it implies no versions loaded or selected.
                // We should probably rely on the backend default or warn.
                // But better to fetch versions first if possible.
                await loadVersions();
                const select = document.getElementById('versionSelect');
                if (select && select.value) proposalId = select.value;
            }

            // Sync dropdown
            const select = document.getElementById('versionSelect');
            if (select && select.value !== proposalId && proposalId) {
                select.value = proposalId;
            }

            showStatus('Detecting conflicts... ‚è≥', 'info');
            document.getElementById('results').innerHTML = '<div class="loading">Detecting conflicts...</div>';

            try {
                let url = `${API_URL}/conflicts/detect`;
                if (proposalId) url += `?proposalId=${proposalId}`;

                const response = await fetch(url, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    showStatus(`Conflict detection complete for Plan ${proposalId || 'All'}! Found ${data.count} conflicts. ‚úÖ`, data.count > 0 ? 'error' : 'success');
                    if (data.data && data.data.length > 0) {
                        displayConflictsTable(data.data);
                    } else {
                        document.getElementById('results').innerHTML = '<p style="text-align: center; padding: 40px; color: #28a745; font-size: 1.2em;">‚úÖ No conflicts detected in this timetable version!</p>';
                    }
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                    displayJSON(data);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = `<pre>${error.message}</pre>`;
            }
        }

        async function viewConflicts() {
            // For now, redirect to detect to ensure fresh data for the selected ID
            // Or separate view?
            // Since "View Conflicts" usually implies reading stored ones, 
            // but our stored ones might be mixed if we don't filter.
            // Let's just alias it to detectConflicts(currentId) for dynamic behavior requested.
            detectConflicts();
        }

        async function showReschedulingUI() {
            currentView = 'rescheduling';
            showStatus('Opening Rescheduling Tools... üîß', 'info');

            // Pre-fetch data for dropdowns
            let faculties = [], rooms = [], timeslots = [];
            try {
                const [fData, rData, tData] = await Promise.all([
                    fetch(`${API_URL}/faculty`).then(r => r.json()),
                    fetch(`${API_URL}/room`).then(r => r.json()),
                    fetch(`${API_URL}/timeslot`).then(r => r.json())
                ]);
                faculties = fData.data;
                rooms = rData.data;
                timeslots = tData.data;
            } catch (e) { console.error(e); }

            // Extract unique days
            const days = [...new Set(timeslots.map(t => t.day))];

            const html = `
    <div style="max-width: 800px; margin: 0 auto;">
        <h3 style="color: #667eea; margin-bottom: 20px;">Dynamic Rescheduling Engine</h3>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">Event Type:</label>
            <select id="resType" onchange="updateResForm()"
                style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 20px;">
                <option value="leave">üë®‚Äçüè´ Faculty Leave</option>
                <option value="room">üö´ Room Unavailability</option>
                <option value="holiday">üéâ Holiday Declaration</option>
            </select>

            <div id="resInputs">
                <!-- Inputs injected here -->
            </div>

            <button onclick="checkImpact()" class="success" style="width: 100%; margin-top: 10px;">Check Impact & Find
                Solutions</button>
        </div>

        <div id="resResults"></div>
    </div>
    `;

            document.getElementById('results').innerHTML = html;

            // Store data globally for the form to use
            window._resData = { faculties, rooms, days };

            // Initialize form
            setTimeout(updateResForm, 100);
        }

        function updateResForm() {
            const type = document.getElementById('resType').value;
            const container = document.getElementById('resInputs');
            const data = window._resData || { faculties: [], rooms: [], days: [] };

            let html = '';

            if (type === 'leave') {
                html += `
    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Faculty:</label>
    <select id="resFaculty" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
        ${data.faculties.map(f => `<option value="${f._id}">${f.name}</option>`).join('')}
    </select>
    `;
            } else if (type === 'room') {
                html += `
    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Room:</label>
    <select id="resRoom" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
        ${data.rooms.map(r => `<option value="${r._id}">${r.name} (${r.roomType})</option>`).join('')}
    </select>
    `;
            }

            html += `
    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Day:</label>
    <select id="resDay" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
        ${data.days.map(d => `<option value="${d}">${d}</option>`).join('')}
    </select>
    `;

            container.innerHTML = html;
        }

        async function checkImpact() {
            const type = document.getElementById('resType').value;
            const day = document.getElementById('resDay').value;
            let body = { day };

            let endpoint = '';
            if (type === 'leave') {
                body.facultyId = document.getElementById('resFaculty').value;
                endpoint = '/rescheduling/check-faculty-leave';
            } else if (type === 'room') {
                body.roomId = document.getElementById('resRoom').value;
                endpoint = '/rescheduling/check-room-maintenance';
            } else {
                endpoint = '/rescheduling/check-holiday';
            }

            // Include Proposal ID if selected
            const select = document.getElementById('versionSelect');
            if (select && select.value) body.proposalId = select.value;

            showStatus('Analyzing impact... ‚è≥', 'info');
            document.getElementById('resResults').innerHTML = '<div class="loading">Analyzing...</div>';

            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (response.ok) {
                    showStatus(`Analysis complete. Found ${data.data.length} issues.`, 'success');
                    displayResResults(data.data, type);
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function displayResResults(items, type) {
            const container = document.getElementById('resResults');
            if (items.length === 0) {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: green; background: #e8f5e9; border-radius: 8px;">‚úÖ No conflicts or affected classes found!</div>`;
                return;
            }

            let html = `<div style="margin-bottom: 20px; font-weight: bold; color: #d32f2f;">Found ${items.length} affected classes. Please resolve them below:</div>`;

            items.forEach((item, index) => {
                const original = item.originalClass;
                const entryId = original._id;

                html += `
                    <div style="background: white; border-left: 5px solid #ff6b6b; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: #333; font-size: 1.1em;">
                                    ${original.courseId?.name || 'Unknown Course'} 
                                    <span style="color: #666; font-weight: normal;">(${original.sectionId?.name})</span>
                                </h4>
                                <div style="color: #666; margin-top: 5px; font-size: 0.9em;">
                                    üìÖ <strong>${original.timeslotId?.day}</strong>, Slot ${original.timeslotId?.slot} 
                                    üìç ${original.roomId?.name} 
                                    üë§ ${original.facultyId?.name}
                                </div>
                            </div>
                            <span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">Action Required</span>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="margin-bottom: 10px; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; color: #555;">Resolution Options:</div>
                `;

                // Render Options based on Type
                // We use radio buttons to select 1 option per class

                // Option 1: Cancel
                html += `
                    <label style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                        <input type="radio" name="action_${entryId}" value="cancel" style="margin-right: 10px;">
                        <span style="flex-grow: 1;"><strong>Cancel Class</strong> <span style="color: #888;">(Schedule compensation later)</span></span>
                    </label>
                `;

                if (type === 'leave') {
                    // Substitutes
                    if (item.options?.substitutes?.length > 0) {
                        html += `<div style="margin: 10px 0 5px; color: #667eea; font-size: 0.9em; font-weight: 600;">üë• Assign Substitute:</div>`;
                        item.options.substitutes.forEach(sub => {
                            html += `
                                <label style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                                    <input type="radio" name="action_${entryId}" value="sub_${sub._id}" style="margin-right: 10px;">
                                    <span style="flex-grow: 1;"><strong>${sub.name}</strong> <span style="color: #28a745; font-size: 0.9em;">(Available)</span></span>
                                </label>
                            `;
                        });
                    }

                    // Reschedule
                    if (item.options?.reschedule?.length > 0) {
                        html += `<div style="margin: 10px 0 5px; color: #667eea; font-size: 0.9em; font-weight: 600;">üìÖ Reschedule to another day:</div>`;
                        item.options.reschedule.forEach(opt => {
                            html += `
                                <label style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                                    <input type="radio" name="action_${entryId}" value="move_${opt.slot._id}_${opt.room._id}" style="margin-right: 10px;">
                                    <span style="flex-grow: 1;">
                                        <strong>${opt.slot.day}, Slot ${opt.slot.slot}</strong> 
                                        in <span style="color: #666;">${opt.room.name}</span>
                                    </span>
                                </label>
                            `;
                        });
                    }
                }

                if (type === 'room') {
                    // Alternate Rooms
                    if (item.options?.alternateRooms?.length > 0) {
                        html += `<div style="margin: 10px 0 5px; color: #667eea; font-size: 0.9em; font-weight: 600;">üè´ Switch Room:</div>`;
                        item.options.alternateRooms.forEach(room => {
                            html += `
                                <label style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                                    <input type="radio" name="action_${entryId}" value="room_${room._id}" style="margin-right: 10px;">
                                    <span style="flex-grow: 1;"><strong>${room.name}</strong> <span style="color: #28a745; font-size: 0.9em;">(${room.roomType})</span></span>
                                </label>
                            `;
                        });
                    }

                    // Reschedule
                    if (item.options?.reschedule?.length > 0) {
                        html += `<div style="margin: 10px 0 5px; color: #667eea; font-size: 0.9em; font-weight: 600;">üìÖ Reschedule (Day/Time):</div>`;
                        item.options.reschedule.forEach(opt => {
                            html += `
                                <label style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                                    <input type="radio" name="action_${entryId}" value="move_${opt.slot._id}_${opt.room._id}" style="margin-right: 10px;">
                                    <span style="flex-grow: 1;">
                                        <strong>${opt.slot.day}, Slot ${opt.slot.slot}</strong> 
                                        ${opt.note ? `<span style="color: orange; font-size: 0.9em;">(${opt.note})</span>` : ''}
                                    </span>
                                </label>
                            `;
                        });
                    }
                }

                if (type === 'holiday') {
                    // Compensation Candidates
                    if (item.compensationOptions?.length > 0) {
                        html += `<div style="margin: 10px 0 5px; color: #667eea; font-size: 0.9em; font-weight: 600;">üóìÔ∏è Schedule Compensation Class:</div>`;
                        item.compensationOptions.forEach(opt => {
                            html += `
                                <label style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                                    <input type="radio" name="action_${entryId}" value="move_${opt.slot._id}_${opt.room._id}" style="margin-right: 10px;">
                                    <span style="flex-grow: 1;">
                                        <strong>${opt.slot.day}, Slot ${opt.slot.slot}</strong> 
                                        in <span style="color: #666;">${opt.room.name}</span>
                                    </span>
                                </label>
                            `;
                        });
                    } else {
                        html += `<div style="padding: 10px; color: #e67e22; background: #fff3e0; border-radius: 4px;">‚ö†Ô∏è No immediate make-up slots found. Class will be cancelled.</div>`;
                    }
                }

                html += `</div></div>`; // End card
            });

            html += `
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="applyRescheduling()" class="success" style="font-size: 1.1em; padding: 12px 30px;">‚úÖ Apply Selected Changes</button>
                </div>
            `;

            container.innerHTML = html;
            window._currentAffectedItems = items; // Store for application
        }

        async function applyRescheduling() {
            if (!window._currentAffectedItems) return;

            const updates = [];
            const items = window._currentAffectedItems;

            // Gather selections
            for (const item of items) {
                const entryId = item.originalClass._id;
                const radios = document.getElementsByName(`action_${entryId}`);
                let selectedValue = null;
                for (const r of radios) {
                    if (r.checked) selectedValue = r.value;
                }

                if (!selectedValue) {
                    alert(`Please select an action for ${item.originalClass.courseId.name}`);
                    return;
                }

                // Parse Action
                const update = { entryId, changes: {} };

                if (selectedValue === 'cancel') {
                    updates.push({ entryId, type: 'cancel' });
                } else if (selectedValue.startsWith('sub_')) {
                    const subId = selectedValue.split('_')[1];
                    update.changes.facultyId = subId;
                    updates.push(update);
                } else if (selectedValue.startsWith('room_')) {
                    const roomId = selectedValue.split('_')[1];
                    update.changes.roomId = roomId;
                    updates.push(update);
                } else if (selectedValue.startsWith('move_')) {
                    const parts = selectedValue.split('_');
                    const slotId = parts[1];
                    const roomId = parts[2];
                    update.changes.timeslotId = slotId;
                    update.changes.roomId = roomId;
                    updates.push(update);
                }
            }

            if (updates.length === 0) {
                alert("Please select an action for at least one class.");
                return;
            }

            showStatus('Applying changes... ‚è≥', 'info');

            try {
                const response = await fetch(`${API_URL}/rescheduling/apply-changes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates })
                });
                const data = await response.json();

                if (response.ok) {
                    showStatus('Changes applied successfully! üöÄ', 'success');
                    showStatus('Changes applied successfully! üöÄ', 'success');
                    document.getElementById('resResults').innerHTML = `<div style="padding: 30px; text-align: center; color: green; background: #e8f5e9; font-size: 1.2em;">üéâ All changes applied successfully!<br><br>
                        <button onclick="viewTimetable()">View Updated Timetable</button>
                        <button onclick="downloadCSV()" class="success" style="margin-left: 10px;">üíæ Download New Timetable</button>
                    </div>`;
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function resolveConflicts(proposalId = null) {
            currentView = 'resolve';

            // Use selected ID if not provided
            if (!proposalId) {
                const select = document.getElementById('versionSelect');
                if (select && select.value) proposalId = select.value;
            }

            // If still no ID, try to load versions
            if (!proposalId) {
                await loadVersions();
                const select = document.getElementById('versionSelect');
                if (select && select.value) proposalId = select.value;

                if (!proposalId) {
                    showStatus('No timetable found. Please generate a timetable first.', 'info');
                    return;
                }
            }

            // Sync dropdown
            const select = document.getElementById('versionSelect');
            if (select && select.value !== proposalId && proposalId) {
                select.value = proposalId;
            }

            showStatus('Resolving conflicts automatically... ‚è≥', 'info');
            document.getElementById('results').innerHTML = '<div class="loading">Analyzing and resolving conflicts...<br>This may take a moment...</div>';

            try {
                let url = `${API_URL}/timetable/conflicts/resolve`;
                if (proposalId) url += `?proposalId=${proposalId}`;

                const response = await fetch(url, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    const result = data.data;

                    if (result.remainingConflicts === 0) {
                        showStatus(`‚úÖ All conflicts resolved! ${result.conflictsResolved} conflicts fixed.`, 'success');

                        // Display success message and show the conflict-free timetable
                        let html = `
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 40px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 25px rgba(17, 153, 142, 0.3);">
                                <h2 style="margin: 0 0 15px 0; font-size: 2.5em; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üéâ Conflict Resolution Successful!</h2>
                                <p style="font-size: 1.3em; margin: 15px 0 25px 0;">A conflict-free timetable has been generated.</p>
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-bottom: 25px; display: inline-block;">
                                    <strong style="font-size: 1.1em;">üëá Scroll down to see the resolution details</strong>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 2em; font-weight: bold;">${result.initialConflicts}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">Initial Conflicts</div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 2em; font-weight: bold;">${result.conflictsResolved}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">Resolved</div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 2em; font-weight: bold;">${result.remainingConflicts}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">Remaining</div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Show resolution details
                        if (result.resolutionLog && result.resolutionLog.length > 0) {
                            html += `
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.5em;">üìã</span> Changes Made to Resolve Conflicts
                                    </h3>
                                    <div style="max-height: 500px; overflow-y: auto;">
                            `;

                            result.resolutionLog.forEach((log, index) => {
                                const action = log.action;
                                const actionIcons = {
                                    'moved': 'üìÖ',
                                    'room_changed': 'üè´',
                                    'moved_and_room_changed': 'üîÑ'
                                };
                                const icon = actionIcons[action.action] || '‚úÖ';

                                const actionColors = {
                                    'moved': '#4CAF50',
                                    'room_changed': '#FF9800',
                                    'moved_and_room_changed': '#2196F3'
                                };
                                const color = actionColors[action.action] || '#667eea';

                                html += `
                                    <div style="background: linear-gradient(to right, ${color}10, white); padding: 15px; margin-bottom: 15px; border-left: 4px solid ${color}; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; color: #333; font-size: 1.05em; margin-bottom: 8px;">
                                                    ${icon} Change #${index + 1}: ${log.type.toUpperCase()} Conflict
                                                </div>
                                                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                                                    <div style="font-weight: 600; color: #555; margin-bottom: 6px; font-size: 0.95em;">üìö Class Details:</div>
                                                    <div style="color: #666; font-size: 0.9em; line-height: 1.6;">
                                                        <strong style="color: #333;">${action.courseName || 'Unknown Course'}</strong> 
                                                        <span style="color: #888;">(${action.courseType || 'N/A'})</span>
                                                        <br>
                                                        üë• Section: <strong>${action.sectionName || 'Unknown'}</strong>
                                                        <br>
                                                        üë®‚Äçüè´ Faculty: <strong>${action.facultyName || 'Unknown'}</strong>
                                                    </div>
                                                </div>
                `;

                                // Show what changed based on action type
                                if (action.action === 'moved') {
                                    html += `
                                        <div style="background: #fff9e6; padding: 12px; border-radius: 6px; border-left: 3px solid #FFC107;">
                                            <div style="font-weight: 600; color: #F57C00; margin-bottom: 8px; font-size: 0.95em;">
                                                ‚è∞ Timeslot Changed:
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center;">
                                                <div style="background: white; padding: 10px; border-radius: 4px; text-align: center; border: 2px solid #ffcdd2;">
                                                    <div style="font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 4px;">Original</div>
                                                    <div style="font-weight: 600; color: #d32f2f;">${action.originalTimeslot?.day || 'N/A'}</div>
                                                    <div style="color: #666; font-size: 0.9em;">Slot ${action.originalTimeslot?.slot || 'N/A'}</div>
                                                </div>
                                                <div style="font-size: 1.5em; color: #4CAF50;">‚Üí</div>
                                                <div style="background: white; padding: 10px; border-radius: 4px; text-align: center; border: 2px solid #c8e6c9;">
                                                    <div style="font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 4px;">New</div>
                                                    <div style="font-weight: 600; color: #2e7d32;">${action.newTimeslot?.day || 'N/A'}</div>
                                                    <div style="color: #666; font-size: 0.9em;">Slot ${action.newTimeslot?.slot || 'N/A'}</div>
                                                </div>
                                            </div>
                                            <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-size: 0.85em; color: #666;">
                                                üìç Room: <strong>${action.roomName || 'Unknown'}</strong> (unchanged)
                                            </div>
                                        </div>
                                    `;
                                } else if (action.action === 'room_changed') {
                                    html += `
                                        <div style="background: #fff3e0; padding: 12px; border-radius: 6px; border-left: 3px solid #FF9800;">
                                            <div style="font-weight: 600; color: #E65100; margin-bottom: 8px; font-size: 0.95em;">
                                                üè´ Room Changed:
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center;">
                                                <div style="background: white; padding: 10px; border-radius: 4px; text-align: center; border: 2px solid #ffcdd2;">
                                                    <div style="font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 4px;">Original</div>
                                                    <div style="font-weight: 600; color: #d32f2f;">${action.originalRoom || 'Unknown'}</div>
                                                </div>
                                                <div style="font-size: 1.5em; color: #FF9800;">‚Üí</div>
                                                <div style="background: white; padding: 10px; border-radius: 4px; text-align: center; border: 2px solid #c8e6c9;">
                                                    <div style="font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 4px;">New</div>
                                                    <div style="font-weight: 600; color: #2e7d32;">${action.newRoom || 'Unknown'}</div>
                                                </div>
                                            </div>
                                            <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-size: 0.85em; color: #666;">
                                                ‚è∞ Timeslot: <strong>${action.timeslot?.day || 'N/A'}, Slot ${action.timeslot?.slot || 'N/A'}</strong> (unchanged)
                                            </div>
                                        </div>
                                    `;
                                } else if (action.action === 'moved_and_room_changed') {
                                    html += `
                                        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 3px solid #2196F3;">
                                            <div style="font-weight: 600; color: #1565C0; margin-bottom: 8px; font-size: 0.95em;">
                                                üîÑ Timeslot AND Room Changed:
                                            </div>
                                            <div style="margin-bottom: 10px;">
                                                <div style="font-size: 0.85em; color: #666; margin-bottom: 6px; font-weight: 600;">‚è∞ Timeslot:</div>
                                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;">
                                                    <div style="background: white; padding: 8px; border-radius: 4px; text-align: center; border: 2px solid #ffcdd2;">
                                                        <div style="font-size: 0.7em; color: #888;">Original</div>
                                                        <div style="font-weight: 600; color: #d32f2f; font-size: 0.9em;">${action.originalTimeslot?.day || 'N/A'}, Slot ${action.originalTimeslot?.slot || 'N/A'}</div>
                                                    </div>
                                                    <div style="font-size: 1.2em; color: #2196F3;">‚Üí</div>
                                                    <div style="background: white; padding: 8px; border-radius: 4px; text-align: center; border: 2px solid #c8e6c9;">
                                                        <div style="font-size: 0.7em; color: #888;">New</div>
                                                        <div style="font-weight: 600; color: #2e7d32; font-size: 0.9em;">${action.newTimeslot?.day || 'N/A'}, Slot ${action.newTimeslot?.slot || 'N/A'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.85em; color: #666; margin-bottom: 6px; font-weight: 600;">üè´ Room:</div>
                                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;">
                                                    <div style="background: white; padding: 8px; border-radius: 4px; text-align: center; border: 2px solid #ffcdd2;">
                                                        <div style="font-size: 0.7em; color: #888;">Original</div>
                                                        <div style="font-weight: 600; color: #d32f2f; font-size: 0.9em;">${action.originalRoom || 'Unknown'}</div>
                                                    </div>
                                                    <div style="font-size: 1.2em; color: #2196F3;">‚Üí</div>
                                                    <div style="background: white; padding: 8px; border-radius: 4px; text-align: center; border: 2px solid #c8e6c9;">
                                                        <div style="font-size: 0.7em; color: #888;">New</div>
                                                        <div style="font-weight: 600; color: #2e7d32; font-size: 0.9em;">${action.newRoom || 'Unknown'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }

                                html += `
                                                <div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 0.85em; color: #555; font-style: italic;">
                                                    üí° ${action.reason}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            html += `
                                    </div>
                                </div>
                            `;
                        }

                        // Add button to view the conflict-free timetable
                        html += `
                            <div style="text-align: center; margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                                <p style="color: white; font-size: 1.1em; margin-bottom: 15px; font-weight: 600;">‚ú® Review the changes above, then click below to view your conflict-free timetable!</p>
                                <button onclick="viewTimetable('${proposalId}')" class="success" style="font-size: 1.2em; padding: 18px 50px; background: white; color: #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                                    üìÖ View Conflict-Free Timetable
                                </button>
                                <button onclick="downloadCSV()" class="secondary" style="font-size: 1.2em; padding: 18px 30px; margin-left: 15px; background: white; color: #f5576c; border: 2px solid #f5576c;">
                                    üíæ Download File
                                </button>
                            </div>
                        `;

                        document.getElementById('results').innerHTML = html;

                        // Scroll to results to ensure visibility
                        setTimeout(() => {
                            const resultsDiv = document.getElementById('results');
                            if (resultsDiv) resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);

                    } else {
                        showStatus(`‚ö†Ô∏è Partially resolved. ${result.conflictsResolved} fixed, ${result.remainingConflicts} remaining.`, 'info');

                        let html = `
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                                <h2 style="margin: 0 0 15px 0; font-size: 2em;">‚ö†Ô∏è Partial Resolution</h2>
                                <p style="font-size: 1.2em; margin: 10px 0;">Some conflicts could not be automatically resolved</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 2em; font-weight: bold;">${result.initialConflicts}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">Initial Conflicts</div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 2em; font-weight: bold;">${result.conflictsResolved}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">Resolved</div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 2em; font-weight: bold;">${result.remainingConflicts}</div>
                                        <div style="font-size: 0.9em; opacity: 0.9;">Remaining</div>
                                    </div>
                                </div>
                            </div>
                        `;

                        if (result.remainingConflictDetails && result.remainingConflictDetails.length > 0) {
                            html += `
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <h3 style="color: #f5576c; margin-bottom: 15px;">Remaining Conflicts:</h3>
                            `;
                            displayConflictsTable(result.remainingConflictDetails);
                        }

                        html += `
                            <div style="text-align: center; margin-top: 20px;">
                                <button onclick="viewTimetable('${proposalId}')" class="success" style="font-size: 1.1em; padding: 15px 40px; margin-right: 10px;">
                                    üìÖ View Current Timetable
                                </button>
                                <button onclick="showReschedulingUI()" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); font-size: 1.1em; padding: 15px 40px;">
                                    üîÑ Manual Rescheduling
                                </button>
                            </div>
                        `;

                        document.getElementById('results').innerHTML = html;
                    }
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                    displayJSON(data);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('results').innerHTML = `<pre>${error.message}</pre>`;
            }
        }

        async function downloadCSV() {
            const select = document.getElementById('versionSelect');
            const proposalId = select ? select.value : '1';

            showStatus('Preparing download... ‚è≥', 'info');

            try {
                let url = `${API_URL}/timetable`;
                if (proposalId) url += `?proposalId=${proposalId}`;

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.data && data.data.length > 0) {
                    const items = data.data;
                    const headers = ['Section', 'Course', 'Type', 'Faculty', 'Room', 'Day', 'Slot'];

                    const csvRows = [headers.join(',')];

                    items.forEach(item => {
                        const row = [
                            `"${item.sectionId?.name || ''}"`,
                            `"${item.courseId?.name || ''}"`,
                            `"${item.courseId?.courseType || ''}"`,
                            `"${item.facultyId?.name || ''}"`,
                            `"${item.roomId?.name || ''}"`,
                            `"${item.timeslotId?.day || ''}"`,
                            `"${item.timeslotId?.slot || ''}"`
                        ];
                        csvRows.push(row.join(','));
                    });

                    const csvString = csvRows.join('\n');
                    const blob = new Blob([csvString], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', `timetable_plan_${proposalId}.csv`);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    showStatus('Download started! üì•', 'success');
                } else {
                    showStatus('No data to download.', 'error');
                }
            } catch (error) {
                showStatus(`Download failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>

</html>